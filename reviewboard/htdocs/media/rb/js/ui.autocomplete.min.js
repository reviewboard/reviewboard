(function(a){a.widget("ui.autocomplete",{_init:function(){a.extend(this.options,{delay:this.options.delay!=undefined?this.options.delay:(this.options.url?this.options.ajaxDelay:this.options.localDelay),max:this.options.max!=undefined?this.options.max:(this.options.scroll?this.options.scrollMax:this.options.noScrollMax),highlight:this.options.highlight||function(y){return y},formatMatch:this.options.formatMatch||this.options.formatItem});var l=this.element[0],g=this.options,b=a(l).attr("autocomplete","off").addClass(g.inputClass),c=a.ui.keyCode,p="",m=a.ui.autocomplete.cache(g),e=0,x={mouseDownOnSelect:false},j,w,u,r=a.ui.autocomplete.select(g,l,d,x);if(g.result){b.bind("result.autocomplete",g.result)}a.browser.opera&&a(l.form).bind("submit.autocomplete",function(){if(w){w=false;return false}});b.bind((a.browser.opera?"keypress":"keydown")+".autocomplete",function(y){u=y.keyCode;switch(y.keyCode){case c.UP:y.preventDefault();if(r.visible()){r.prev()}else{t(0,true)}break;case c.DOWN:y.preventDefault();if(r.visible()){r.next()}else{t(0,true)}break;case c.PAGE_UP:y.preventDefault();if(r.visible()){r.pageUp()}else{t(0,true)}break;case c.PAGE_DOWN:y.preventDefault();if(r.visible()){r.pageDown()}else{t(0,true)}break;case g.multiple&&a.trim(g.multipleSeparator)==","&&c.COMMA:case c.TAB:case c.ENTER:if(d()){y.preventDefault();w=true;return false}break;case c.ESCAPE:r.hide();break;default:clearTimeout(j);j=setTimeout(t,g.delay);break}}).focus(function(){e++}).blur(function(){e=0;if(!x.mouseDownOnSelect){s()}}).click(function(){if(e++>1&&!r.visible()){t(0,true)}}).bind("search",function(){var y=(arguments.length>1)?arguments[1]:null;function z(D,C){var A;if(C&&C.length){for(var B=0;B<C.length;B++){if(C[B].result.toLowerCase()==D.toLowerCase()){A=C[B];break}}}if(typeof y=="function"){y(A)}else{b.trigger("result",A&&[A.data,A.value])}}a.each(h(b.val()),function(A,B){f(B,z,z)})}).bind("flushCache",function(){m.flush()}).bind("setOptions",function(){a.extend(g,arguments[1]);if("data" in arguments[1]){m.populate()}}).bind("unautocomplete",function(){r.unbind();b.unbind();a(l.form).unbind(".autocomplete")});function d(){var z=r.selected();if(!z){return false}var y=z.result;p=y;if(g.multiple){var A=h(b.val());if(A.length>1){y=A.slice(0,A.length-1).join(g.multipleSeparator)+g.multipleSeparator+y}y+=g.multipleSeparator}b.val(y);v();b.trigger("result",[z.data,z.value]);return true}function t(A,z){if(u==a.ui.keyCode.DELETE){r.hide();return}var y=b.val();if(!z&&y==p){return}p=y;y=i(y);if(y.length>=g.minChars){b.addClass(g.loadingClass);if(!g.matchCase){y=y.toLowerCase()}f(y,k,v)}else{n();r.hide()}}function h(z){if(!z){return[""]}if(!g.multiple){return[z]}var A=z.split(g.multipleSeparator);var y=[];a.each(A,function(B,C){if(a.trim(C)){y[B]=a.trim(C)}});return y}function i(y){var z=h(y);return z[z.length-1]}function q(y,z){if(g.autoFill&&(i(b.val()).toLowerCase()==y.toLowerCase())&&u!=a.ui.keyCode.BACKSPACE){b.val(b.val()+z.substring(i(p).length));a.ui.autocomplete.selection(l,p.length,p.length+z.length)}}function s(){clearTimeout(j);j=setTimeout(v,200)}function v(){var y=r.visible();r.hide();clearTimeout(j);n();if(g.mustMatch){b.autocomplete("search",function(z){if(!z){if(g.multiple){var A=h(b.val()).slice(0,-1);b.val(A.join(g.multipleSeparator)+(A.length?g.multipleSeparator:""))}else{b.val("")}}})}if(y){a.ui.autocomplete.selection(l,l.value.length,l.value.length)}}function k(z,y){if(y&&y.length&&e){n();r.display(y,z);q(z,y[0].value);r.show()}else{v()}}function f(B,D,A){if(!g.matchCase){B=B.toLowerCase()}var C=m.load(B);if(C&&C.length){D(B,C)}else{if((typeof g.url=="string")&&(g.url.length>0)){var E={timestamp:+new Date()};a.each(g.extraParams,function(F,G){E[F]=typeof G=="function"?G(B):G});a.ajax({mode:"abort",port:"autocomplete"+l.name,dataType:g.dataType,url:g.url,data:a.extend({q:i(B),limit:g.max},E),success:function(G){var F=g.parse&&g.parse(G)||o(G);m.add(B,F);D(B,F)}})}else{if(g.source&&typeof g.source=="function"){var z=g.source(B);var y=(g.parse)?g.parse(z):z;m.add(B,y);D(B,y)}else{r.emptyList();A(B)}}}}function o(B){var y=[];var A=B.split("\n");for(var z=0;z<A.length;z++){var C=a.trim(A[z]);if(C){C=C.split("|");y[y.length]={data:C,value:C[0],result:g.formatResult&&g.formatResult(C,C[0])||C[0]}}}return y}function n(){b.removeClass(g.loadingClass)}},_propagate:function(c,b){a.ui.plugin.call(this,c,[b,this.ui()]);return this.element.triggerHandler(c=="autocomplete"?c:"autocomplete"+c,[b,this.ui()],this.options[c])},ui:function(b){return{options:this.options,element:this.element}},result:function(b){return this.element.bind("result",b)},search:function(b){return this.element.trigger("search",[b])},flushCache:function(){return this.element.trigger("flushCache")},setData:function(b,c){return this.element.trigger("setOptions",[{key:c}])},destroy:function(){this.element.removeAttr("disabled").removeClass("ui-autocomplete-input");return this.element.trigger("unautocomplete")},enable:function(){this.element.removeAttr("disabled").removeClass("ui-autocomplete-disabled");this.disabled=false},disable:function(){this.element.attr("disabled",true).addClass("ui-autocomplete-disabled");this.disabled=true}});a.extend(a.ui.autocomplete,{defaults:{inputClass:"ui-autocomplete-input",resultsClass:"ui-autocomplete-results",loadingClass:"ui-autocomplete-loading",minChars:1,ajaxDelay:400,localDelay:10,matchCase:false,matchSubset:true,matchContains:false,cacheLength:10,scrollMax:150,noScrollMax:10,mustMatch:false,extraParams:{},selectFirst:true,formatItem:function(b){return b[0]},formatMatch:null,autoFill:false,width:0,multiple:false,multipleSeparator:", ",highlight:function(c,b){return c.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+b.replace(/([\^\$\(\)\[\]\{\}\*\.\+\?\|\\])/gi,"\\$1")+")(?![^<>]*>)(?![^&;]+;)","gi"),"<strong>$1</strong>")},scroll:true,scrollHeight:180,clickToURL:false,}});a.ui.autocomplete.cache=function(c){var f={};var d=0;function h(l,k){if(!c.matchCase){l=l.toLowerCase()}var j=l.indexOf(k);if(j==-1){return false}return j==0||c.matchContains}function g(j,i){if(d>c.cacheLength){b()}if(!f[j]){d++}f[j]=i}function e(){if(!c.data){return false}var k={},j=0;if(!c.url){c.cacheLength=1}k[""]=[];for(var m=0,l=c.data.length;m<l;m++){var p=c.data[m];p=(typeof p=="string")?[p]:p;var o=c.formatMatch(p,m+1,c.data.length);if(o===false){continue}var n=o.charAt(0).toLowerCase();if(!k[n]){k[n]=[]}var q={value:o,data:p,result:c.formatResult&&c.formatResult(p)||o};k[n].push(q);if(j++<c.max){k[""].push(q)}}a.each(k,function(r,s){c.cacheLength++;g(r,s)})}setTimeout(e,25);function b(){f={};d=0}return{flush:b,add:g,populate:e,load:function(n){if(!c.cacheLength||!d){return null}if(!c.url&&c.matchContains){var m=[];for(var j in f){if(j.length>0){var o=f[j];a.each(o,function(p,k){if(h(k.value,n)){m.push(k)}})}}return m}else{if(f[n]){return f[n]}else{if(c.matchSubset){for(var l=n.length-1;l>=c.minChars;l--){var o=f[n.substr(0,l)];if(o){var m=[];a.each(o,function(p,k){if(h(k.value,n)){m[m.length]=k}});return m}}}}}return null}}};a.ui.autocomplete.select=function(e,j,l,q){var i={ACTIVE:"ui-autocomplete-over"};var k,f=-1,s,m="",t=true,c,p;function o(){if(!t){return}c=a("<div/>").hide().addClass(e.resultsClass).css("position","absolute").appendTo(document.body);p=a("<ul/>").appendTo(c).mouseover(function(u){if(r(u).nodeName&&r(u).nodeName.toUpperCase()=="LI"){f=a("li",p).removeClass(i.ACTIVE).index(r(u));a(r(u)).addClass(i.ACTIVE)}}).click(function(u){a(r(u)).addClass(i.ACTIVE);l();j.focus();return false}).mousedown(function(){q.mouseDownOnSelect=true}).mouseup(function(){q.mouseDownOnSelect=false});if(e.width>0){c.css("width",e.width)}t=false}function r(v){var u=v.target;while(u&&u.tagName!="LI"){u=u.parentNode}if(!u){return[]}return u}function h(u){k.slice(f,f+1).removeClass(i.ACTIVE);g(u);var w=k.slice(f,f+1).addClass(i.ACTIVE);if(e.scroll){var v=0;k.slice(0,f).each(function(){v+=this.offsetHeight});if((v+w[0].offsetHeight-p.scrollTop())>p[0].clientHeight){p.scrollTop(v+w[0].offsetHeight-p.innerHeight())}else{if(v<p.scrollTop()){p.scrollTop(v)}}}}function g(u){f+=u;if(f<0){f=k.size()-1}else{if(f>=k.size()){f=0}}}function b(u){return e.max&&e.max<u?e.max:u}function n(u){if(e.clickToURL===false){return a("<li/>")}else{return a("<li/>").click(function(){window.open(u.url)})}}function d(){p.empty();var v=b(s.length);for(var w=0;w<v;w++){if(!s[w]){continue}var x=e.formatItem(s[w].data,w+1,v,s[w].value,m);if(x===false){continue}var u=n(s[w].data).html(e.highlight(x,m)).addClass(w%2==0?"ui-autocomplete-even":"ui-autocomplete-odd").appendTo(p)[0];a.data(u,"ui-autocomplete-data",s[w])}k=p.find("li");if(e.selectFirst){k.slice(0,1).addClass(i.ACTIVE);f=0}if(a.fn.bgiframe){p.bgiframe()}}return{display:function(v,u){o();s=v;m=u;d()},next:function(){h(1)},prev:function(){h(-1)},pageUp:function(){if(f!=0&&f-8<0){h(-f)}else{h(-8)}},pageDown:function(){if(f!=k.size()-1&&f+8>k.size()){h(k.size()-1-f)}else{h(8)}},hide:function(){c&&c.hide();k&&k.removeClass(i.ACTIVE);f=-1;a(j).triggerHandler("autocompletehide",[{},{options:e}],e.hide)},visible:function(){return c&&c.is(":visible")},current:function(){return this.visible()&&(k.filter("."+i.ACTIVE)[0]||e.selectFirst&&k[0])},show:function(){var w=a(j).offset();c.css({width:typeof e.width=="string"||e.width>0?e.width:a(j).width(),top:w.top+j.offsetHeight,left:w.left}).show();if(e.scroll){p.scrollTop(0);p.css({maxHeight:e.scrollHeight,overflow:"auto"});if(a.browser.msie&&typeof document.body.style.maxHeight==="undefined"){var u=0;k.each(function(){u+=this.offsetHeight});var v=u>e.scrollHeight;p.css("height",v?e.scrollHeight:u);if(!v){k.width(p.width()-parseInt(k.css("padding-left"))-parseInt(k.css("padding-right")))}}}a(j).triggerHandler("autocompleteshow",[{},{options:e}],e.show)},selected:function(){var u=k&&k.filter("."+i.ACTIVE).removeClass(i.ACTIVE);return u&&u.length&&a.data(u[0],"ui-autocomplete-data")},emptyList:function(){p&&p.empty()},unbind:function(){c&&c.remove()}}};a.ui.autocomplete.selection=function(d,e,c){if(d.createTextRange){var b=d.createTextRange();b.collapse(true);b.moveStart("character",e);b.moveEnd("character",c);b.select()}else{if(d.setSelectionRange){d.setSelectionRange(e,c)}else{if(d.selectionStart){d.selectionStart=e;d.selectionEnd=c}}}d.focus()}})(jQuery);