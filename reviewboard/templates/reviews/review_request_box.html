{% load djblets_utils i18n reviewtags staticfiles %}

{% include "reviews/review_request_dlgs.html" %}

 <div class="header">
  <div id="summary_wrapper"><label for="summary">{% trans "Summary" %}:</label><h1 id="summary" class="editable required">{{review_request_details.summary|escape}}</h1></div>
  <p id="status">
{% with review_request_details.time_added|date as dateadded and review_request_details.last_updated as lastupdated and review_request_details.last_updated|date:"c" as lastupdatedraw and latest_diffset.timestamp|date:"c" as lastdiffdateraw and latest_diffset.timestamp as lastdiffdate %}
{%  blocktrans with review_request.display_id as review_request_id and review_request.get_absolute_url as review_request_url %}
    Review Request <a href="{{review_request_url}}">#{{review_request_id}}</a> -
{%  endblocktrans %}
{%  if review_request.status == 'S' %}
{%   blocktrans %}
   Created {{dateadded}} and submitted
   <time class="timesince" datetime="{{lastupdatedraw}}">{{lastupdated}}</time>
{%   endblocktrans %}
{%  elif review_request.status == 'D' %}
{%   blocktrans %}
   Created {{dateadded}} and discarded
   <time class="timesince" datetime="{{lastupdatedraw}}">{{lastupdated}}</time>
{%   endblocktrans %}
{%  elif review_request.status == 'P' %}
{%   blocktrans %}
   Created {{dateadded}} and updated
   <time class="timesince" datetime="{{lastupdatedraw}}">{{lastupdated}}</time>
{%   endblocktrans %}
{%  endif %}
{%  if latest_diffset %}
{%   blocktrans %}
   - Latest diff uploaded
   <time class="timesince" datetime="{{lastdiffdateraw}}">{{lastdiffdate}}</time>
{%   endblocktrans %}
{%  endif %}
{% endwith %}
  </p>
 </div>
 <div id="review-request-warning"></div>

 <table id="review_request_details">
  <colgroup>
   <col width="0%" />
   <col width="100%" />
  </colgroup>
  <thead class="review-request-info">
   <tr><th colspan="2">{% trans "Information" %}</tr>
  </thead>
  <tbody>
   <tr>
    <th><label for="submitter">{% trans "Submitter" %}:</label></th>
    <td><span><a id="submitter" class="user" href="{% url 'user' review_request.submitter %}">{{review_request.submitter|user_displayname}}</a></span></td>
   </tr>
{% if review_request.repository %}
   <tr>
    <th><label for="repository">{% trans "Repository" %}:</label></th>
    <td><span id="repository">{{review_request.repository}}</span></td>
   </tr>
{% endif %}
   <tr>
    <th><label for="branch">{% trans "Branch" %}:</label></th>
    <td id="branch-value-cell"><span id="branch" class="editable">{{review_request_details.branch}}</span></td>
   </tr>
   <tr>
    <th><label for="bugs_closed">{% trans "Bugs" %}:</label></th>
    <td id="bugs-closed-value-cell"><span id="bugs_closed" class="editable comma-editable">{% spaceless %}
{%  for bug in review_request_details.get_bug_list %}
{%   with bug|bug_url:review_request as bug_url %}
{%    if bug_url %}<a href="{{bug_url}}">{{bug}}</a>{% else %}{{bug}}{% endif %}{% if not forloop.last %}, {% endif %}
{%   endwith %}
{%  endfor %}
{% endspaceless %}</span></td>
   </tr>
   <tr>
    <th><label for="depends_on">{% trans "Depends On" %}:</label></th>
    <td id="depends-value-cell"><span id="depends_on" class="editable comma-editable">
{% spaceless %}
{%  for dependency in review_request_details.depends_on.all %}
     <a href="{{dependency.get_absolute_url}}">{{dependency.get_display_id}}</a>{% if not forloop.last %}, {% endif %}
{%  endfor %}
{% endspaceless %}
    </span></td>
   </tr>

{% if blocks %}
   <tr>
    <th><label for="blocks">{% trans "Blocks" %}:</label></th>
    <td id="blocks-value-cell"><span id="blocks">
{%  spaceless %}
{%   for dependency in blocks %}
     <a href="{{dependency.get_absolute_url}}">{{dependency.get_display_id}}</a>{% if not forloop.last %}, {% endif %}
{%   endfor %}
{%  endspaceless %}
    </span></td>
   </tr>
{% endif %}

{% if review_request.commit %}
   <tr>
    <th><label for="commit">{% trans "Change" %}:</label></th>
    <td><span id="commit">{{review_request.commit}}{% if review_request.changeset_is_pending %} {% trans "(pending)" %} {% endif %}</span></td>
   </tr>
{% endif %}
  </tbody>
  <thead>
   <tr>
    <th colspan="2">{% trans "Reviewers" %}
{% if review_request.status == 'P' %}
{%  if request.user == review_request.submitter or perms.reviews.can_edit_reviewrequest %}
     <span class="required-flag" aria-label="{% trans 'This field is required' %}" title="{% trans 'This field is required' %}">*</span>
{%  endif %}
{% endif %}
    </th>
   </tr>
  </thead>
  <tbody>
   <tr>
    <th><label for="target_groups">{% trans "Groups" %}:</label></th>
    <td id="target-groups-value-cell"><span id="target_groups" class="editable">{% spaceless %}
{%  for group in review_request_details.target_groups.all %}
<a href="{% url 'group' group %}">{{group}}</a>{%if not forloop.last %}, {%endif %}
{%  endfor %}
{% endspaceless %}</span></td>
   </tr>
   <tr>
    <th><label for="target_people">{% trans "People" %}:</label></th>
    <td id="target-people-value-cell"><span id="target_people" class="editable comma-editable">{% spaceless %}
{%  for person in review_request_details.target_people.all %}
<a href="{% url 'user' person %}" class="user{% if not person.is_active %} inactive{% endif %}">{{person}}</a>{% if not forloop.last %}, {% endif %}
{%  endfor %}
{% endspaceless %}</span></td>
   </tr>
  </tbody>

{% if detail_hooks %}
  <thead>
   <tr><th colspan="2">{% trans "Extra Fields" %}</th></tr>
  </thead>
  <tbody>
{%  for hook in detail_hooks %}
  <tr>
   <th><label for="{{hook.get_field_id}}">{{hook.get_label}}:</label></th>
   <td><span id="{{hook.get_field_id}}">{{hook.get_detail}}</span></td>
  </tr>
{%  endfor %}
  </tbody>
{% endif %}
 </table>

 <div id="review_request_main">
  <div class="content" id="description-value-cell">
   <label class="textarea-label" for="description">{% trans "Description" %}</label>
   <pre id="description" class="editable required{% if review_request_details.description %} loading{% endif %}" data-rich-text="true">{{review_request_details.description|markdown_escape:review_request_details.rich_text}}</pre>
  </div>
  <div class="content" id="testing-done-value-cell">
   <label class="textarea-label" for="testing_done">{% trans "Testing Done" %}</label>
   <pre id="testing_done" class="editable{% if review_request_details.testing_done %} loading{% endif %}" data-rich-text="true">{{review_request_details.testing_done|markdown_escape:review_request_details.rich_text}}</pre>
  </div>
 </div>

 <div id="review_request_extra">
  <div class="content"{% if not screenshots %} style="display: none;"{% endif %}>
   <h3>{% trans "Screenshots" %}</h3>
   <div id="screenshot-thumbnails">
{% for image in screenshots %}
    <div class="screenshot-container" data-screenshot-id="{{image.id}}">
     <div class="image" onclick="javascript:window.location='{{image.get_absolute_url}}'; return false;"><a href="{{image.get_absolute_url}}">{{image.thumb}}</a></div>
     <div class="screenshot-caption">
      <a href="{{image.get_absolute_url}}" class="edit">{% if draft %}{{image.draft_caption|default:image.caption}}{% else %}{{image.caption}}{% endif %}</a>
{%  if request.user.pk == review_request.submitter_id or perms.reviews.delete_screenshot %}
      <a href="#" class="delete rb-icon rb-icon-delete" title="{% trans "Delete Screenshot" %}"></a>
{%  endif %}
     </div>
    </div>
{% endfor %}
    <br clear="both" />
   </div>
  </div>

  <div class="content clearfix"{% if not file_attachments %} style="display: none;"{% endif %}>
   <h3>{% trans "File Attachments" %}</h3>
   <div id="file-list">
{% for file in file_attachments %}
    <div class="file-container" data-file-id="{{file.id}}">
     <div class="file">
      <ul class="actions">
{%  if request.user.is_authenticated %}
{%   if file.review_ui %}
       <li class="{% if file.review_ui.allow_inline %}file-review-inline %}{% else %}file-review{% endif %}"><a href="{% url 'file_attachment' review_request.display_id file.pk %}">{% trans "Review" %}</a></li>
{%   else %}
       <li class="file-add-comment"><a href="#">{% trans "New Comment" %}</a></li>
{%   endif %}
{%  endif %}
      </ul>
      <div class="file-header">
       <a href="{{file.get_absolute_url}}">
        <img class="icon" src="{{file.icon_url}}" />
        <span class="filename">{{file.filename}}</span>
       </a>
{%  if request.user.pk == review_request.submitter_id or perms.reviews.delete_file %}
       <a href="#" class="delete rb-icon rb-icon-delete" title="{% trans "Delete FIle" %}"></a>
{%  endif %}
      </div>
      <div class="file-thumbnail-container">
{%  if file.review_ui %}
       <a href="{% url 'file_attachment' review_request.display_id file.pk %}" class="file-thumbnail-overlay"> </a>
       {{file.thumbnail}}
{%  else %}
       {{file.thumbnail}}
{%  endif %}
       {% if file.review_ui %}</a>{% endif %}
      </div>
      <div class="file-caption">
{%  definevar "caption" %}{% if draft %}{{file.draft_caption}}{% else %}{{file.caption}}{% endif %}{% enddefinevar %}
{%  if caption %}
       <a href="{{file.get_absolute_url}}" class="edit">{{caption}}</a>
{%  else %}
       <a href="{{file.get_absolute_url}}" class="edit empty-caption">No caption</a>
{%  endif %}
      </div>
     </div>
    </div>
{% endfor %}
   <br clear="both" />
  </div>
 </div>

{% include "reviews/review_issue_summary_table.html" %}
</div>
